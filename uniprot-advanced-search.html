<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="uniprot-tree-select.html">
<link rel="import" href="uniprot-styling.html">

<dom-module id="uniprot-advanced-search">
  <template>
    <style include="uniprot-styling"></style>
    <style>
    :host {
      display: block;
    }
    </style>
    <h4>Search:</h4>
    <paper-input label="Search" value="{{input}}"> </paper-input>
    <ul>
      <template is="dom-repeat" items="{{paths}}">
          <li><a on-click="selectNode" id={{item.id}}>{{item.path}}</a></li>
      </template>
    </ul>
    <h4>Select:</h4>
    <uniprot-tree-select data="[[data.members]]" selection="{{selection}}"></uniprot-tree-select>
    <div>
      <template is="dom-repeat" items="{{inputs}}">
        <label>{{item.label}}
          <input type="{{item.type}}">
        </label>
      </template>
    </div>
  </template>

  <script>
    /**
     * `uniprot-advanced-search`
     * Advanced search component for UniProt
     *
     * @customElement
     * @polymer
     * @demo demo/uniprot-advanced-search-demo.html
     */
    class UniProtAdvancedSearch extends Polymer.Element {

      static get is() {
        return 'uniprot-advanced-search';
      }

      static get properties() {
        return {
          data: {
            type: Object
          },
          input: {
            type: String
          },
          paths: {
            type: Array
          },
          selection: {
            type: String
          },
          inputs: {
            type: Array,
            value: []
          }, mode: {
            type: String
          }
        }
      }

      static get observers() {
        return [
          '_findInPath(input)', '_selectItems(selection)'
        ]
      }

      constructor() {
        super();
      }

      connectedCallback() {
        super.connectedCallback();
      }


      _findPathsInTree(members, searchTerm, paths, currentPath) {
        //TODO don't think it finds 1st level nodes...
        for (let member of members) {
          let newPath = '';
          // Leaf node
          if (currentPath.length <= 0) {
            newPath = `${member.label}`;
          } else {
            newPath = `${currentPath} > ${member.label}`;
          }
          if (!member.members) {
            if (newPath.toLowerCase().indexOf(searchTerm.toLowerCase()) > 0) {
              paths.push({'path': newPath, 'id': member.id});
            }
          } else if (member.members && member.members.length > 0) {
            this._findPathsInTree(member.members, searchTerm, paths, newPath);
          }
        }
      }

      _findInPath(searchTerm) {
        if (this.data) {
          //TODO hide dropdown, show autocomplete
          let paths = [];
          this._findPathsInTree(this.data.members, searchTerm, paths, '');
          this.paths = paths;
        }
      }

      _getNode(id) {
        console.log('done');
        let node = this._traverseTree(this.data, id);
        this.inputs = node.inputs;
      }

      selectNode(e) {
        console.log(e);
        this._getNode(e.target.id);
      }

      _traverseTree(item, id) {
        if (item.id === id) {
          return item;
        }
        else if (item.members) {
          let result = null;
          for (let member of item.members) {
            if(result === null) {
              result =  this._traverseTree(member, id);
            }
          }
          return result;
        }
        return null;
      }

      _selectItems(selectedItem) {
        this._getNode(selectedItem);
      }

    }
    window.customElements.define(UniProtAdvancedSearch.is, UniProtAdvancedSearch);
  </script>
</dom-module>
