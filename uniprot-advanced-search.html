<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="uniprot-tree-select.html">
<link rel="import" href="uniprot-styling.html">

<dom-module id="uniprot-advanced-search">
  <template>
    <style include="uniprot-styling"></style>
    <style>
    :host {
      display: block;
    }
    paper-input {
      display: inline-block;
    }
    paper-button.uniprot-button {
      background-color: #00709b;
      color: white;
      text-transform: none;
    }
    .query-input-container {
      display: inline-block;
    }
    </style>
    <h4>Search:</h4>
    <paper-input label="Search" value="{{input}}"> </paper-input>
    <ul>
      <template is="dom-repeat" items="{{paths}}">
          <li><a on-click="handleClick" id="{{_getPathLastId(item)}}">{{_getPathString(item)}}</a></li>
      </template>
    </ul>
    <h4>Select:</h4>
    <paper-menu-button id="field-drowpdown-container">
      <paper-button raised slot="dropdown-trigger" class="uniprot-button">{{_getPathString(selectedpath, 30)}}</paper-button>
      <uniprot-tree-select slot="dropdown-content" data="[[data.members]]" selectedpath="{{selectedpath}}"></uniprot-tree-select>
    </paper-menu-button>
    <div class="query-input-container">
      <template is="dom-repeat" items="{{inputs}}">
        <template is="dom-if" if="{{isSelect(item)}}">
          <paper-dropdown-menu label="{{item.label}}">
            <paper-listbox slot="dropdown-content" selected="1">
              <template is="dom-repeat" items="{{item.options}}">
                <paper-item>{{item}}</paper-item>
              </template>
            </paper-listbox>
            {{item.options}}
          </paper-dropdown-menu>
          <!-- paper-dropdown-menu -->
        </template>
        <template is="dom-if" if="{{isInput(item)}}">
          <paper-input type="{{item.type}}" label="{{item.label}}" placeholder="{{item.placeholder}}" id="{{item.queryField}}">
        </template>
      </template>
    </div>
  </template>

  <script>
    /**
     * `uniprot-advanced-search`
     * Advanced search component for UniProt
     *
     * @customElement
     * @polymer
     * @demo demo/uniprot-advanced-search-demo.html
     */
    class UniProtAdvancedSearch extends Polymer.Element {

      static get is() {
        return 'uniprot-advanced-search';
      }

      static get properties() {
        return {
          data: {
            type: Object
          },
          input: {
            type: String
          },
          paths: {
            type: Array,
            value: []
          },
          selectedpath: {
            type: Array,
            value: [{
              "label":"All"
            }]
          },
          inputs: {
            type: Array,
            value: [{
              'type': 'text',
              'label': 'Term',
              'placeholder': 'A4_human,...'
            }]
          }
        }
      }

      static get observers() {
        return [
          '_findInPath(input)', '_selectItems(selectedpath)'
        ]
      }

      _hasMatchInPath(searchTerm, path) {
        for(let item of path) {
          if(item.label.toLowerCase().indexOf(searchTerm.toLowerCase()) >= 0) {
            return true;
          }
        }
        return false;
      }

      _getPathString(path, maxLength) {
        let stringPath = '';
        for(let item of path) {
          if(stringPath.length <= 0) {
            stringPath = item.label;
          } else {
            stringPath = `${stringPath} > ${item.label}`;
          }
        }
        if(stringPath.length > maxLength) {
          let strLength = stringPath.length;
          stringPath = `${stringPath.substring(0,3)}...${stringPath.substring((strLength-maxLength)+6,strLength)}`;
        }
        return stringPath;
      }

      _getPathLastId(path) {
        return path[path.length-1].id;
      }

      _findPathsInTree(item, searchTerm, path) {
        path.push(item);
        if(item.members) {
          for (let member of item.members) {
            this._findPathsInTree(member, searchTerm, path);
          }
        }
        else if(this._hasMatchInPath(searchTerm, path)) {
          this.paths.push(path.slice(0));
        }
        path.pop();
      }

      _findInPath(searchTerm) {
        if (this.data) {
          this.paths = [];
          if(searchTerm.length > 0) {
            this._findPathsInTree(this.data, searchTerm, []);
          }
        }
      }

      _selectNode(path) {
        let node = path[path.length - 1];
        this.inputs = node.inputs;
      }

      _getPath(members, id, path = []) {
        for (let item of members) {
          path.push(item);
          if (item.id === id) {
            return path;
          } else if (item.members) {
            let result = this._getPath(item.members, id, path);
            if(result) {
              return result;
            }
          }
          path.pop();
        }
      }

      handleClick(e) {
        let path = this._getPath(this.data.members, e.target.id);
        this.selectedpath = path;
      }

      _selectItems(selectedpath) {
        this.shadowRoot.querySelector('#field-drowpdown-container').close();
        this._selectNode(selectedpath);
      }

      isSelect(item) {
        return item.type === 'select';
      }

      isInput(item) {
        return item.type === 'text' | 'number' | 'hidden';
      }

    }
    window.customElements.define(UniProtAdvancedSearch.is, UniProtAdvancedSearch);
  </script>
</dom-module>
